<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html>
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8">
<title>agj</title>
<meta name="description" content="Ale Grilli's website" />
<link rel="icon" type="image/gif" href="/icon.gif" />

<script type='text/javascript' src='js/mootools.js'></script>
<script type='text/javascript' src='js/agj/agj.js'></script>

<style type="text/less">
	@colorText: @color1;
	@colorBackground: @color2;
	@colorHover: @color3;

	@color1: #ffff00;
	@color2: #00ffff;
	@color3: #ff00ff;
	@color4: #ff9999;

	body {
		color: @colorText;
		background-color: @colorBackground;
		
		font: 160pt/0.8 Helvetica, "Helvetica Neue", "Trebuchet MS", Trebuchet, Lucida, sans-serif;
		font-weight: bold;
		letter-spacing: 0;
		
		margin: 0;
		padding: 0;
	}
	
	a, a:visited, a:link {
		color: @colorText;
		text-decoration: none;
	}
	a:hover {
		color: @colorHover;
		z-index: 1000;
		position: relative;
	}
	
	#wrapper {
		margin-bottom: 20px;
		overflow: hidden;
	}
	
	#main {
		margin-top: -5px;
		margin-bottom: 20px;
		margin-left: -20px;
		margin-right: -40px;
		overflow: visible;
	}
	
	#about {
		width: 360px;
		font-size: 14pt;
		line-height: 1.2;
		font-weight: normal;
		letter-spacing: 0.01em;
		height: 75.5pt;
		padding: 5pt 7pt;
		margin-left: 21px;
		margin-right: 40px;
		margin-bottom: 21.3pt;
		display: inline-block;
		vertical-align: bottom;
		border: 2px solid #colorText;
	}
</style>

<script type='text/javascript' src='js/less.js'></script>

<script type="text/javascript">

	(function (g) {

		var cfg = {
			letterSwapInterval: 800,
			colors: [
				0xffff00,
				0x00ffff,
				0xff00ff,
				0x9999ff
			]
		};

		
		/////

		var trace = AGJ.trace;
		
		var br = "<br />";
		
		var letterNodes; // Array
		var lineBreaks; // Array
		var lineBreaksDirty; // Boolean
		
		document.addEvent("domready", function onDOMReady() {
			var main = $("main");

			// Letter swapping.
			replaceTextNodesWithSpans(main); // Wraps every letter with <span class="char"> tags.
			letterNodes = getLetterNodes(main); // Finds the nodes with those span tags and puts them in an Array.
			processLetterNodes(); // Adds zero-width spaces after each character, so words may wrap at any position.
			updateLineBreaks(); // Finds where the text breaks, so as later not to make changes to the text that would alter its flow on the page.
			
			// Random colors.
			var colors = chooseRandomColors();
			setColors(colors);
			
			// Events.
			setInterval(onInterval, cfg.letterSwapInterval);
			window.addEvent("resize", onResize);
		} );

		function chooseRandomColors() {
			var s = [];

			var remaining = cfg.colors.concat();
			for (var i = 3; i > 0; i--) {
				var index = Math.floor(Math.random() * remaining.length);
				s.push(remaining[index]);
				remaining.splice(index, 1);
			}

			return {
				background: s[0],
				text: s[1],
				hover: s[2]
			};
		}

		function setColors(c) {


			// var styles = document.styleSheets[0];
			// var rules = styles.cssRules;

			// for (var i = rules.length - 1; i >= 0; i--) {

			// }

			// trace(styles.cssRules.toString());

			// styles.insertRule(
			// 	"body {" +
			// 	"   background-color: #" + c.background.toHex(6) + "; " +
			// 	"   color: #" + c.text.toHex(6) + "; " +
			// 	"}",
			// 	styles.cssRules.length
			// );
			// styles.insertRule(
			// 	"a, a:visited, a:link {" +
			// 	"   color: #" + c.text.toHex(6) + "; " +
			// 	"}",
			// 	styles.cssRules.length
			// );
			// styles.insertRule(
			// 	"a:hover {" +
			// 	"   color: #" + c.hover.toHex(6) + "; " +
			// 	"}",
			// 	styles.cssRules.length
			// );

			// $$("body").setStyles( {
			// 	backgroundColor: "#" + c.background.toHex(6),
			// 	color: "#" + c.text.toHex(6)
			// } );
		}

		
		/////
		
		function replaceTextNodesWithSpans(parent) {
			var children = parent.childNodes;
			if (!children || children.length == 0)
				return null;
			var current;
			var len = children.length;
			for (var i = 0; i < len; i++) {
				current = children[i];
				if (instanceOf(current, Text)) {
					parent.replaceChild(putLettersIntoSpans(current), current);
				} else if (current) {
					replaceTextNodesWithSpans(current);
				}
			}
		}
		
		function getLetterNodes(main) { // Array
			var letterNodes = main.getElements("span.char");
			return letterNodes;
		}
		
		function processLetterNodes() {
			var current, space;
			var len = letterNodes.length;
			for (var i = 0; i < len; i++) {
				current = letterNodes[i];
				if (Browser.safari || Browser.chrome)
					current.set("html", current.get("html") + "<wbr/>"); // WTF.
				else
					current.set("html", current.get("html") + "&#8203;");
			}
		}
		
		function updateLineBreaks() {
			lineBreaks = [];
			var currYPos;
			var yPos = letterNodes[0].getPosition().y;
			var len = letterNodes.length;
			for (var i = 1; i < len; i++) {
				current = letterNodes[i];
				currYPos = current.getPosition().y;
				if (yPos !== currYPos) {
					lineBreaks.push(i);
					yPos = currYPos;
				}
			}
			addHardBreaks();
			lineBreaksDirty = false;
		}
		
		/////
		
		function putLettersIntoSpans(textNode) { // span Element
			var container = new Element("span");
			var text = fixWhitespace(textNode.data);
			var len = text.length, char;
			for (var i = 0; i < len; i++) {
				char = text.charAt(i);
				if (isSwappableChar(char))
					container.adopt(new Element("span", { "class": "char", html: char } ));
				else
					container.adopt(new Element("span", { html: char } ));
			}
			return container;
		}
		
		function swapLetterPair() {
			if (lineBreaksDirty)
				updateLineBreaks();
			
			var pos = Math.floor(Math.random() * (letterNodes.length - 1));
			while (lineBreaks.indexOf(pos + 1) >= 0) {
				pos++;
			}
			
			var textNode1 = letterNodes[pos].childNodes[0];
			var textNode2 = letterNodes[pos + 1].childNodes[0];
			
			var textTemp = textNode1.data;
			textNode1.data = textNode2.data;
			textNode2.data = textTemp;
		}
		
		function addHardBreaks() {
			var current;
			var len = lineBreaks.length;
			for (var i = 0; i < len; i++) {
				current = letterNodes[lineBreaks[i]];
				if (current.parentNode.childNodes[0] !== current) {
					var brk = new Element("br", { "class": "break" });
					brk.inject(current, "before");
				}
			}
		}
		
		function removeHardBreaks() {
			var breaks = $("main").getElements("br.break");
			var len = breaks.length;
			for (var i = 0; i < len; i++) {
				breaks[i].destroy();
			}
		}
		
		function removeUnwantedChars(text) { // String
			return text.replace(/\W/g, "");
		}
		
		function fixWhitespace(text) { // String
			if (!text)
				return "";
			return text.replace(/\s+/g, " ");
		}
		
		function isSwappableChar(letter) { // Boolean
			return (letter.search(/\w/) === 0);
		}
		
		/////
		
		function onKeyDown(e) {
			swapLetterPair();
		}
		
		function onMouseOverLink(e) {
			swapLetterPair();
		}
		
		function onInterval() {
			swapLetterPair();
		}
		
		function onResize(e) {
			if (!lineBreaksDirty) {
				lineBreaksDirty = true;
				removeHardBreaks();
			}
		}

	})(this);
	
</script>


</head>


<body>
	
	<div id="wrapper">
	<div id="main">
		Ale Grilli.
		<a href="http://blog.agj.cl/">Blog.</a>
		<a href="/games/">Games.</a>
		<a href="/portfolio/">Portfolio.</a>
		<div id="about">
			<b>Graphic and media designer, creative coder from Chile.</b>
			See also my
				<a href="http://twitter.com/#!/alegrilli">Twitter,</a>
				<a href="http://alegrilli.tumblr.com/">Tumblr,</a>
				<a href="http://www.listography.com/agj/">Listography,</a>
				<a href="http://www.vimeo.com/agj/">Vimeo,</a>
				<a href="http://gamejolt.com/profile/agj/1042/">Gamejolt,</a>
				<a href="http://cllct.com/family/agj">Cllct.</a>
			<a href="http://piclog.agj.cl/">My old 'piclog'.</a>
		</div>
	</div>
	</div>

</body>
</html>
